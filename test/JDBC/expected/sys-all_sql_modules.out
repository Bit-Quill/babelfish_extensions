-- Setup
CREATE DATABASE db1
GO

CREATE VIEW my_master_view AS -- This view should not be seen as we will be using a different database for the test
SELECT 1
GO

USE db1
GO

CREATE VIEW all_sql_modules_view AS
SELECT 1
GO

CREATE FUNCTION all_sql_modules_function() 
RETURNS INT
AS 
BEGIN
    RETURN 1;
END
GO

CREATE PROC all_sql_modules_proc AS
SELECT 1
GO

CREATE TABLE all_sql_modules_table1(a int)
GO

CREATE TABLE all_sql_modules_table2(a int)
GO

CREATE TRIGGER sql_mod_trig ON all_sql_modules_table2 INSTEAD OF INSERT
AS
BEGIN
SELECT * FROM all_sql_modules_table1;
END
GO

-- Test for function
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('all_sql_modules_function')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
CREATE OR REPLACE FUNCTION dbo.all_sql_modules_function()<newline> RETURNS integer<newline> LANGUAGE pltsql<newline>AS '{"version_num": "1", "typmod_array": ["-1"], "original_probin": ""}', $function$BEGIN<newline>    RETURN 1;<newline>END$function$<newline>#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for views
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('all_sql_modules_view')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
 SELECT 1;#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for triggers
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sql_mod_trig')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
<NULL>#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for proc
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('all_sql_modules_proc')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
CREATE OR REPLACE PROCEDURE dbo.all_sql_modules_proc()<newline> LANGUAGE pltsql<newline>AS '{"version_num": "1", "typmod_array": [], "original_probin": ""}', $procedure$SELECT 1$procedure$<newline>#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for system function
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('fn_sqlvarbasetostr')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
~~END~~


-- Test for system view
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys.tables')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
 SELECT t.relname AS name,<newline>    t.oid AS object_id,<newline>    NULL::integer AS principal_id,<newline>    sch.schema_id,<newline>    0 AS parent_object_id,<newline>    'U'::character varying(2) AS type,<newline>    'USER_TABLE'::character varying(60) AS type_desc,<newline>    NULL::timestamp without time zone AS create_date,<newline>    NULL::timestamp without time zone AS modify_date,<newline>    0 AS is_ms_shipped,<newline>    0 AS is_published,<newline>    0 AS is_schema_published,<newline>        CASE t.reltoastrelid<newline>            WHEN 0 THEN 0<newline>            ELSE 1<newline>        END AS lob_data_space_id,<newline>    NULL::integer AS filestream_data_space_id,<newline>    t.relnatts AS max_column_id_used,<newline>    0 AS lock_on_bulk_load,<newline>    1 AS uses_ansi_nulls,<newline>    0 AS is_replicated,<newline>    0 AS has_replication_filter,<newline>    0 AS is_merge_published,<newline>    0 AS is_sync_tran_subscribed,<newline>    0 AS has_unchecked_assembly_data,<newline>    0 AS text_in_row_limit,<newline>    0 AS large_value_types_out_of_row,<newline>    0 AS is_tracked_by_cdc,<newline>    0 AS lock_escalation,<newline>    'TABLE'::character varying(60) AS lock_escalation_desc,<newline>    0 AS is_filetable,<newline>    0 AS durability,<newline>    'SCHEMA_AND_DATA'::character varying(60) AS durability_desc,<newline>    0 AS is_memory_optimized,<newline>        CASE t.relpersistence<newline>            WHEN 't'::"char" THEN 2<newline>            ELSE 0<newline>        END AS temporal_type,<newline>        CASE t.relpersistence<newline>            WHEN 't'::"char" THEN 'SYSTEM_VERSIONED_TEMPORAL_TABLE'::text<newline>            ELSE 'NON_TEMPORAL_TABLE'::text<newline>        END AS temporal_type_desc,<newline>    NULL::integer AS history_table_id,<newline>    0 AS is_remote_data_archive_enabled,<newline>    0 AS is_external<newline>   FROM (pg_class t<newline>     JOIN schemas sch ON ((t.relnamespace = sch.schema_id)))<newline>  WHERE ((t.relpersistence = ANY (ARRAY['p'::"char", 'u'::"char", 't'::"char"])) AND (t.relkind = 'r'::"char") AND (NOT is_table_type(t.oid)) AND has_schema_privilege(sch.schema_id, 'USAGE'::text) AND has_table_privilege(t.oid, 'SELECT,INSERT,UPDATE,DELETE,TRUNCATE,TRIGGER'::text));#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for system proc
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sp_tables')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
CREATE OR REPLACE PROCEDURE sys.sp_tables(IN "@table_name" nvarchar DEFAULT ''::"varchar", IN "@table_owner" nvarchar DEFAULT ''::"varchar", IN "@table_qualifier" sysname DEFAULT ''::"varchar", IN "@table_type" nvarchar DEFAULT ''::"varchar", IN "@fusepattern" "bit" DEFAULT '1'::"bit")<newline> LANGUAGE pltsql<newline>AS '{"version_num": "1", "typmod_array": ["384", "384", "-1", "100", "-1"], "original_probin": ""}', $procedure$<newline> DECLARE @opt_table sys.varchar(16) = '';<newline> DECLARE @opt_view sys.varchar(16) = '';<newline>BEGIN<newline> IF (@table_qualifier != '') AND (LOWER(@table_qualifier) != LOWER(sys.db_name()))<newline> BEGIN<newline>  THROW 33557097, N'The database name component of the object qualifier must be the name of the current database.', 1;<newline> END<newline> SELECT<newline> CAST(out_table_qualifier AS sys.sysname) AS TABLE_QUALIFIER,<newline> CAST(out_table_owner AS sys.sysname) AS TABLE_OWNER,<newline> CAST(out_table_name AS sys.sysname) AS TABLE_NAME,<newline> CAST(out_table_type AS sys.varchar(32)) AS TABLE_TYPE,<newline> CAST(out_remarks AS sys.varchar(254)) AS REMARKS<newline> FROM sys.sp_tables_internal(@table_name, @table_owner, @table_qualifier, CAST(@table_type AS varchar(100)), @fusepattern);<newline>END;<newline>$procedure$<newline>#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test that sys.all_sql_modules is database-scoped
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('my_master_view')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
~~END~~


-- Test permission for all_sql_modules (query should not have any results)
CREATE LOGIN all_sql_modules_user WITH PASSWORD='test'
GO

CREATE USER all_sql_modules_user FOR LOGIN all_sql_modules_user
GO

USE master
GO

-- tsql user=all_sql_modules_user password=test

USE db1
GO

SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('all_sql_modules_proc')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
~~END~~


USE master
GO

-- tsql
USE db1
GO

DROP LOGIN all_sql_modules_user
GO

-- Cleanup
DROP PROC all_sql_modules_proc
GO

DROP TRIGGER sql_mod_trig
GO

DROP TABLE all_sql_modules_table1
GO

DROP TABLE all_sql_modules_table2
GO

DROP VIEW all_sql_modules_view
GO

DROP FUNCTION all_sql_modules_function
GO

USE master
GO

DROP VIEW my_master_view
GO

DROP DATABASE db1
GO
